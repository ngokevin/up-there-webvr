<!DOCTYPE html>  <html> <head>   <title>tests.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="pagelet.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               tests.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span><span class="nx">spawn</span><span class="p">,</span> <span class="nx">exec</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&#39;child_process&#39;</span>
<span class="nv">path          = </span><span class="nx">require</span> <span class="s">&#39;path&#39;</span>
<span class="nv">fs            = </span><span class="nx">require</span> <span class="s">&#39;fs&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Determine the test and resources paths</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">testPath      = </span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">realpathSync</span><span class="p">(</span><span class="nx">__filename</span><span class="p">)</span>
<span class="nv">dataPath      = </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">testPath</span><span class="p">,</span> <span class="s">&quot;data&quot;</span>
<span class="nv">resourcesPath = </span><span class="nx">path</span><span class="p">.</span><span class="nx">normalize</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">testPath</span><span class="p">,</span><span class="s">&quot;/../resources&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Run a Docco pass and check that the number of output files
is equal to what is expected.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">testDoccoRun = </span><span class="nf">(testName,sources,options=null,callback=null) -&gt;</span>
  <span class="nv">destPath = </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">dataPath</span><span class="p">,</span> <span class="nx">testName</span>
  <span class="nv">cleanup = </span><span class="nf">(callback) -&gt;</span> <span class="nx">exec</span> <span class="s">&quot;rm -rf </span><span class="si">#{</span><span class="nx">destPath</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="nx">callback</span>
  <span class="nx">cleanup</span> <span class="nf">-&gt;</span>
    <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nv">output = </span><span class="nx">destPath</span>
    <span class="nx">Docco</span><span class="p">.</span><span class="nb">document</span> <span class="nx">sources</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nf">-&gt;</span>
      <span class="nv">files       = </span><span class="p">[]</span>
      <span class="nv">files       = </span><span class="nx">files</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">Docco</span><span class="p">.</span><span class="nx">resolveSource</span><span class="p">(</span><span class="nx">src</span><span class="p">))</span> <span class="k">for</span> <span class="nx">src</span> <span class="k">in</span> <span class="nx">sources</span>
      <span class="nv">expected    = </span><span class="nx">files</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="nv">found       = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">destPath</span><span class="p">).</span><span class="nx">length</span>
      <span class="nx">eq</span> <span class="nx">found</span><span class="p">,</span> <span class="nx">expected</span><span class="p">,</span> <span class="s">&quot;find expected output (</span><span class="si">#{</span><span class="nx">expected</span><span class="si">}</span><span class="s"> files) - (</span><span class="si">#{</span><span class="nx">found</span><span class="si">}</span><span class="s">)&quot;</span>
      <span class="nx">callback</span><span class="p">()</span> <span class="k">if</span> <span class="nx">callback</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p><strong>Custom jst template files should be supported</strong></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">test</span> <span class="s">&quot;custom JST template file&quot;</span><span class="p">,</span> <span class="nf">-&gt;</span>
  <span class="nx">testDoccoRun</span> <span class="s">&quot;custom_jst&quot;</span><span class="p">,</span> 
    <span class="p">[</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">testPath</span><span class="si">}</span><span class="s">/*.coffee&quot;</span><span class="p">],</span>
    <span class="nv">template: </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">resourcesPath</span><span class="si">}</span><span class="s">/pagelet.jst&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p><strong>Custom CSS files should be supported</strong></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">test</span> <span class="s">&quot;custom CSS file&quot;</span><span class="p">,</span> <span class="nf">-&gt;</span>
  <span class="nx">testDoccoRun</span> <span class="s">&quot;custom_css&quot;</span><span class="p">,</span> 
    <span class="p">[</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">testPath</span><span class="si">}</span><span class="s">/*.coffee&quot;</span><span class="p">],</span>
    <span class="nv">css: </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">resourcesPath</span><span class="si">}</span><span class="s">/pagelet.css&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p><strong>Comments should be parsed properly</strong></p>

<p>There are special data files located in <code>test/comments</code> for each supported 
language.  The first comment in  each file corresponds to the expected number 
of comments to be parsed from its contents.</p>

<p>This test iterates over all the known Docco languages, and tests the ones 
that have a corresponding data file in <code>test/comments</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">test</span> <span class="s">&quot;single line comment parsing&quot;</span><span class="p">,</span> <span class="nf">-&gt;</span>
  <span class="nv">commentsPath = </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">testPath</span><span class="p">,</span> <span class="s">&quot;comments&quot;</span>
  <span class="nv">options           = template: </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">commentsPath</span><span class="si">}</span><span class="s">/comments.jst&quot;</span>
  <span class="nv">languageKeys = </span><span class="p">(</span><span class="nx">ext</span> <span class="k">for</span> <span class="nx">ext</span><span class="p">,</span><span class="nx">l</span> <span class="k">of</span> <span class="nx">Docco</span><span class="p">.</span><span class="nx">languages</span><span class="p">)</span>

  <span class="nv">testNextLanguage = </span><span class="nf">(keys,callback) -&gt;</span>
    <span class="k">return</span> <span class="nx">callback</span><span class="o">?</span><span class="p">()</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span>

    <span class="nv">extension       = </span><span class="nx">keys</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
    <span class="nv">language        = </span><span class="nx">Docco</span><span class="p">.</span><span class="nx">languages</span><span class="p">[</span><span class="nx">extension</span><span class="p">]</span>
    <span class="nv">languageExample = </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">commentsPath</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">language</span><span class="p">.</span><span class="nx">name</span><span class="si">}#{</span><span class="nx">extension</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nv">languageTest    = </span><span class="s">&quot;comments_test/</span><span class="si">#{</span><span class="nx">language</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nv">languagePath    = </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">dataPath</span><span class="p">,</span> <span class="nx">languageTest</span>
    <span class="nv">languageOutput  = </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">languagePath</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">language</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s">.html&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p><em>Skip over this language if there is no corresponding test</em></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">testNextLanguage</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span> <span class="nx">languageExample</span>   
   
    <span class="nx">testDoccoRun</span> <span class="nx">languageTest</span><span class="p">,</span> <span class="p">[</span><span class="nx">languageExample</span><span class="p">],</span> <span class="nx">options</span><span class="p">,</span> <span class="nf">-&gt;</span>
      <span class="nx">eq</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">languageOutput</span><span class="p">),</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">languageOutput</span><span class="si">}</span><span class="s"> -&gt; output file created properly&quot;</span>

      <span class="nv">content = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">languageOutput</span><span class="p">).</span><span class="nx">toString</span><span class="p">()</span>
      <span class="nv">comments = </span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="k">for</span> <span class="nx">c</span> <span class="k">in</span> <span class="nx">content</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span> <span class="k">when</span> <span class="nx">c</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">)</span> 

      <span class="nx">eq</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">comments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;expect at least the descriptor comment&#39;</span>

      <span class="nv">expected = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>    
      
      <span class="nx">eq</span> <span class="nx">comments</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">expected</span><span class="p">,</span> <span class="p">[</span>
        <span class="s">&quot;&quot;</span>
        <span class="s">&quot;</span><span class="si">#{</span><span class="nx">path</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">languageOutput</span><span class="p">)</span><span class="si">}</span><span class="s"> comments&quot;</span>
        <span class="s">&quot;------------------------&quot;</span>
        <span class="s">&quot; expected : </span><span class="si">#{</span><span class="nx">expected</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="s">&quot; found    : </span><span class="si">#{</span><span class="nx">comments</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="p">].</span><span class="nx">join</span> <span class="s">&#39;\n&#39;</span>
      
      <span class="nx">testNextLanguage</span> <span class="nx">keys</span><span class="p">,</span> <span class="nx">callback</span>
      </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p><em>Kick off the first language test</em></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">testNextLanguage</span> <span class="nx">languageKeys</span><span class="p">.</span><span class="nx">slice</span><span class="p">()</span>
     

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 